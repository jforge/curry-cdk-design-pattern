"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const assets_1 = require("../lib/assets");
const util_1 = require("./util");
test('prepare assets', async () => {
    // GIVEN
    const assembly = util_1.testAssembly({
        stacks: [{
                stackName: 'SomeStack',
                template: {
                    Resources: {
                        SomeResource: {
                            Type: 'AWS::Something::Something'
                        }
                    }
                },
                assets: [
                    {
                        sourceHash: 'source-hash',
                        path: __filename,
                        id: 'SomeStackSomeResource4567',
                        packaging: 'file',
                        s3BucketParameter: 'BucketParameter',
                        s3KeyParameter: 'KeyParameter',
                        artifactHashParameter: 'ArtifactHashParameter',
                    }
                ]
            }]
    });
    const toolkit = new FakeToolkit();
    // WHEN
    const params = await assets_1.prepareAssets(assembly.getStackByName('SomeStack'), toolkit);
    // THEN
    expect(params).toEqual([
        { ParameterKey: 'BucketParameter', ParameterValue: 'bucket' },
        { ParameterKey: 'KeyParameter', ParameterValue: 'assets/SomeStackSomeResource4567/||12345.ts' },
        { ParameterKey: 'ArtifactHashParameter', ParameterValue: '12345' },
    ]);
});
test('prepare assets with reuse', async () => {
    // GIVEN
    const stack = util_1.testStack({
        stackName: 'SomeStack',
        assets: [
            {
                path: __filename,
                id: 'SomeStackSomeResource4567',
                packaging: 'file',
                s3BucketParameter: 'BucketParameter',
                s3KeyParameter: 'KeyParameter',
                artifactHashParameter: 'ArtifactHashParameter',
                sourceHash: 'boom'
            }
        ],
        template: {
            Resources: {
                SomeResource: {
                    Type: 'AWS::Something::Something'
                }
            }
        }
    });
    const toolkit = new FakeToolkit();
    // WHEN
    const params = await assets_1.prepareAssets(stack, toolkit, undefined, ['SomeStackSomeResource4567']);
    // THEN
    expect(params).toEqual([
        { ParameterKey: 'BucketParameter', UsePreviousValue: true },
        { ParameterKey: 'KeyParameter', UsePreviousValue: true },
        { ParameterKey: 'ArtifactHashParameter', UsePreviousValue: true },
    ]);
});
test('prepare container asset with reuse', async () => {
    // GIVEN
    const stack = util_1.testStack({
        stackName: 'SomeStack',
        assets: [
            {
                path: __dirname,
                id: 'SomeStackSomeResource4567',
                packaging: 'container-image',
                imageNameParameter: 'asdf',
                sourceHash: 'source-hash'
            }
        ],
        template: {
            Resources: {
                SomeResource: {
                    Type: 'AWS::Something::Something'
                }
            }
        }
    });
    const toolkit = new FakeToolkit();
    // WHEN
    const params = await assets_1.prepareAssets(stack, toolkit, undefined, ['SomeStackSomeResource4567']);
    // THEN
    expect(params).toEqual([
        { ParameterKey: 'asdf', UsePreviousValue: true },
    ]);
});
class FakeToolkit {
    constructor() {
        this.bucketUrl = 'https://bucket';
        this.bucketName = 'bucket';
    }
    async uploadIfChanged(_data, props) {
        const filename = `12345${props.s3KeySuffix}`;
        return {
            filename,
            key: `${props.s3KeyPrefix}${filename}`,
            hash: '12345',
            changed: true,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhc3NldHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDBDQUE4QztBQUM5QyxpQ0FBaUQ7QUFFakQsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEtBQUssSUFBSSxFQUFFO0lBQ2hDLFFBQVE7SUFDUixNQUFNLFFBQVEsR0FBRyxtQkFBWSxDQUFDO1FBQzVCLE1BQU0sRUFBRSxDQUFDO2dCQUNQLFNBQVMsRUFBRSxXQUFXO2dCQUN0QixRQUFRLEVBQUU7b0JBQ1IsU0FBUyxFQUFFO3dCQUNULFlBQVksRUFBRTs0QkFDWixJQUFJLEVBQUUsMkJBQTJCO3lCQUNsQztxQkFDRjtpQkFDRjtnQkFDRCxNQUFNLEVBQUU7b0JBQ047d0JBQ0UsVUFBVSxFQUFFLGFBQWE7d0JBQ3pCLElBQUksRUFBRSxVQUFVO3dCQUNoQixFQUFFLEVBQUUsMkJBQTJCO3dCQUMvQixTQUFTLEVBQUUsTUFBTTt3QkFDakIsaUJBQWlCLEVBQUUsaUJBQWlCO3dCQUNwQyxjQUFjLEVBQUUsY0FBYzt3QkFDOUIscUJBQXFCLEVBQUUsdUJBQXVCO3FCQUMvQztpQkFDRjthQUNGLENBQUM7S0FDSCxDQUFDLENBQUM7SUFFSCxNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBRWxDLE9BQU87SUFDUCxNQUFNLE1BQU0sR0FBRyxNQUFNLHNCQUFhLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsRUFBRSxPQUFjLENBQUMsQ0FBQztJQUV6RixPQUFPO0lBQ1AsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQztRQUNyQixFQUFFLFlBQVksRUFBRSxpQkFBaUIsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFO1FBQzdELEVBQUUsWUFBWSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsNkNBQTZDLEVBQUU7UUFDL0YsRUFBRSxZQUFZLEVBQUUsdUJBQXVCLEVBQUUs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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVXBsb2FkZWQsIFVwbG9hZFByb3BzIH0gZnJvbSAnLi4vbGliJztcbmltcG9ydCB7IHByZXBhcmVBc3NldHMgfSBmcm9tICcuLi9saWIvYXNzZXRzJztcbmltcG9ydCB7IHRlc3RBc3NlbWJseSwgdGVzdFN0YWNrIH0gZnJvbSAnLi91dGlsJztcblxudGVzdCgncHJlcGFyZSBhc3NldHMnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IGFzc2VtYmx5ID0gdGVzdEFzc2VtYmx5KHtcbiAgICBzdGFja3M6IFt7XG4gICAgICBzdGFja05hbWU6ICdTb21lU3RhY2snLFxuICAgICAgdGVtcGxhdGU6IHtcbiAgICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgICAgU29tZVJlc291cmNlOiB7XG4gICAgICAgICAgICBUeXBlOiAnQVdTOjpTb21ldGhpbmc6OlNvbWV0aGluZydcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBhc3NldHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHNvdXJjZUhhc2g6ICdzb3VyY2UtaGFzaCcsXG4gICAgICAgICAgcGF0aDogX19maWxlbmFtZSxcbiAgICAgICAgICBpZDogJ1NvbWVTdGFja1NvbWVSZXNvdXJjZTQ1NjcnLFxuICAgICAgICAgIHBhY2thZ2luZzogJ2ZpbGUnLFxuICAgICAgICAgIHMzQnVja2V0UGFyYW1ldGVyOiAnQnVja2V0UGFyYW1ldGVyJyxcbiAgICAgICAgICBzM0tleVBhcmFtZXRlcjogJ0tleVBhcmFtZXRlcicsXG4gICAgICAgICAgYXJ0aWZhY3RIYXNoUGFyYW1ldGVyOiAnQXJ0aWZhY3RIYXNoUGFyYW1ldGVyJyxcbiAgICAgICAgfVxuICAgICAgXVxuICAgIH1dXG4gIH0pO1xuXG4gIGNvbnN0IHRvb2xraXQgPSBuZXcgRmFrZVRvb2xraXQoKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IHBhcmFtcyA9IGF3YWl0IHByZXBhcmVBc3NldHMoYXNzZW1ibHkuZ2V0U3RhY2tCeU5hbWUoJ1NvbWVTdGFjaycpLCB0b29sa2l0IGFzIGFueSk7XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocGFyYW1zKS50b0VxdWFsKFtcbiAgICB7IFBhcmFtZXRlcktleTogJ0J1Y2tldFBhcmFtZXRlcicsIFBhcmFtZXRlclZhbHVlOiAnYnVja2V0JyB9LFxuICAgIHsgUGFyYW1ldGVyS2V5OiAnS2V5UGFyYW1ldGVyJywgUGFyYW1ldGVyVmFsdWU6ICdhc3NldHMvU29tZVN0YWNrU29tZVJlc291cmNlNDU2Ny98fDEyMzQ1LnRzJyB9LFxuICAgIHsgUGFyYW1ldGVyS2V5OiAnQXJ0aWZhY3RIYXNoUGFyYW1ldGVyJywgUGFyYW1ldGVyVmFsdWU6ICcxMjM0NScgfSxcbiAgXSk7XG59KTtcblxudGVzdCgncHJlcGFyZSBhc3NldHMgd2l0aCByZXVzZScsIGFzeW5jICgpID0+IHtcbiAgLy8gR0lWRU5cbiAgY29uc3Qgc3RhY2sgPSB0ZXN0U3RhY2soe1xuICAgIHN0YWNrTmFtZTogJ1NvbWVTdGFjaycsXG4gICAgYXNzZXRzOiBbXG4gICAgICB7XG4gICAgICAgIHBhdGg6IF9fZmlsZW5hbWUsXG4gICAgICAgIGlkOiAnU29tZVN0YWNrU29tZVJlc291cmNlNDU2NycsXG4gICAgICAgIHBhY2thZ2luZzogJ2ZpbGUnLFxuICAgICAgICBzM0J1Y2tldFBhcmFtZXRlcjogJ0J1Y2tldFBhcmFtZXRlcicsXG4gICAgICAgIHMzS2V5UGFyYW1ldGVyOiAnS2V5UGFyYW1ldGVyJyxcbiAgICAgICAgYXJ0aWZhY3RIYXNoUGFyYW1ldGVyOiAnQXJ0aWZhY3RIYXNoUGFyYW1ldGVyJyxcbiAgICAgICAgc291cmNlSGFzaDogJ2Jvb20nXG4gICAgICB9XG4gICAgXSxcbiAgICB0ZW1wbGF0ZToge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIFNvbWVSZXNvdXJjZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlNvbWV0aGluZzo6U29tZXRoaW5nJ1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgY29uc3QgdG9vbGtpdCA9IG5ldyBGYWtlVG9vbGtpdCgpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgcGFyYW1zID0gYXdhaXQgcHJlcGFyZUFzc2V0cyhzdGFjaywgdG9vbGtpdCBhcyBhbnksIHVuZGVmaW5lZCwgWydTb21lU3RhY2tTb21lUmVzb3VyY2U0NTY3J10pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBhcmFtcykudG9FcXVhbChbXG4gICAgeyBQYXJhbWV0ZXJLZXk6ICdCdWNrZXRQYXJhbWV0ZXInLCBVc2VQcmV2aW91c1ZhbHVlOiB0cnVlIH0sXG4gICAgeyBQYXJhbWV0ZXJLZXk6ICdLZXlQYXJhbWV0ZXInLCBVc2VQcmV2aW91c1ZhbHVlOiB0cnVlIH0sXG4gICAgeyBQYXJhbWV0ZXJLZXk6ICdBcnRpZmFjdEhhc2hQYXJhbWV0ZXInLCBVc2VQcmV2aW91c1ZhbHVlOiB0cnVlIH0sXG4gIF0pO1xufSk7XG5cbnRlc3QoJ3ByZXBhcmUgY29udGFpbmVyIGFzc2V0IHdpdGggcmV1c2UnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHN0YWNrID0gdGVzdFN0YWNrKHtcbiAgICBzdGFja05hbWU6ICdTb21lU3RhY2snLFxuICAgIGFzc2V0czogW1xuICAgICAge1xuICAgICAgICBwYXRoOiBfX2Rpcm5hbWUsXG4gICAgICAgIGlkOiAnU29tZVN0YWNrU29tZVJlc291cmNlNDU2NycsXG4gICAgICAgIHBhY2thZ2luZzogJ2NvbnRhaW5lci1pbWFnZScsXG4gICAgICAgIGltYWdlTmFtZVBhcmFtZXRlcjogJ2FzZGYnLFxuICAgICAgICBzb3VyY2VIYXNoOiAnc291cmNlLWhhc2gnXG4gICAgICB9XG4gICAgXSxcbiAgICB0ZW1wbGF0ZToge1xuICAgICAgUmVzb3VyY2VzOiB7XG4gICAgICAgIFNvbWVSZXNvdXJjZToge1xuICAgICAgICAgIFR5cGU6ICdBV1M6OlNvbWV0aGluZzo6U29tZXRoaW5nJ1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgY29uc3QgdG9vbGtpdCA9IG5ldyBGYWtlVG9vbGtpdCgpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgcGFyYW1zID0gYXdhaXQgcHJlcGFyZUFzc2V0cyhzdGFjaywgdG9vbGtpdCBhcyBhbnksIHVuZGVmaW5lZCwgWydTb21lU3RhY2tTb21lUmVzb3VyY2U0NTY3J10pO1xuXG4gIC8vIFRIRU5cbiAgZXhwZWN0KHBhcmFtcykudG9FcXVhbChbXG4gICAgeyBQYXJhbWV0ZXJLZXk6ICdhc2RmJywgVXNlUHJldmlvdXNWYWx1ZTogdHJ1ZSB9LFxuICBdKTtcbn0pO1xuXG5jbGFzcyBGYWtlVG9vbGtpdCB7XG4gIHB1YmxpYyBidWNrZXRVcmw6IHN0cmluZyA9ICdodHRwczovL2J1Y2tldCc7XG4gIHB1YmxpYyBidWNrZXROYW1lOiBzdHJpbmcgPSAnYnVja2V0JztcblxuICBwdWJsaWMgYXN5bmMgdXBsb2FkSWZDaGFuZ2VkKF9kYXRhOiBhbnksIHByb3BzOiBVcGxvYWRQcm9wcyk6IFByb21pc2U8VXBsb2FkZWQ+IHtcbiAgICBjb25zdCBmaWxlbmFtZSA9IGAxMjM0NSR7cHJvcHMuczNLZXlTdWZmaXh9YDtcbiAgICByZXR1cm4ge1xuICAgICAgZmlsZW5hbWUsXG4gICAgICBrZXk6IGAke3Byb3BzLnMzS2V5UHJlZml4fSR7ZmlsZW5hbWV9YCxcbiAgICAgIGhhc2g6ICcxMjM0NScsXG4gICAgICBjaGFuZ2VkOiB0cnVlLFxuICAgIH07XG4gIH1cbn1cbiJdfQ==