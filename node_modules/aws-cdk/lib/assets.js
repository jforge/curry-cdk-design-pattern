"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// tslint:disable-next-line:max-line-length
const cxapi = require("@aws-cdk/cx-api");
const colors = require("colors");
const fs = require("fs-extra");
const os = require("os");
const path = require("path");
const archive_1 = require("./archive");
const docker_1 = require("./docker");
const logging_1 = require("./logging");
// tslint:disable-next-line:max-line-length
async function prepareAssets(stack, toolkitInfo, ci, reuse) {
    reuse = reuse || [];
    const assets = stack.assets;
    if (assets.length === 0) {
        return [];
    }
    if (!toolkitInfo) {
        // tslint:disable-next-line:max-line-length
        throw new Error(`This stack uses assets, so the toolkit stack must be deployed to the environment (Run "${colors.blue("cdk bootstrap " + stack.environment.name)}")`);
    }
    let params = new Array();
    for (const asset of assets) {
        // FIXME: Should have excluded by construct path here instead of by unique ID, preferably using
        // minimatch so we can support globs. Maybe take up during artifact refactoring.
        const reuseAsset = reuse.indexOf(asset.id) > -1;
        if (reuseAsset) {
            logging_1.debug(`Preparing asset ${asset.id}: ${JSON.stringify(asset)} (reusing)`);
        }
        else {
            logging_1.debug(`Preparing asset ${asset.id}: ${JSON.stringify(asset)}`);
        }
        if (!stack.assembly) {
            throw new Error(`Unexpected: stack assembly is required in order to find assets in assemly directory`);
        }
        const assemblyDir = stack.assembly.directory;
        params = params.concat(await prepareAsset(assemblyDir, asset, toolkitInfo, reuseAsset, ci));
    }
    return params;
}
exports.prepareAssets = prepareAssets;
// tslint:disable-next-line:max-line-length
async function prepareAsset(assemblyDir, asset, toolkitInfo, reuse, ci) {
    switch (asset.packaging) {
        case 'zip':
            return await prepareZipAsset(assemblyDir, asset, toolkitInfo, reuse);
        case 'file':
            return await prepareFileAsset(assemblyDir, asset, toolkitInfo, reuse);
        case 'container-image':
            return await docker_1.prepareContainerAsset(assemblyDir, asset, toolkitInfo, reuse, ci);
        default:
            // tslint:disable-next-line:max-line-length
            throw new Error(`Unsupported packaging type: ${asset.packaging}. You might need to upgrade your aws-cdk toolkit to support this asset type.`);
    }
}
async function prepareZipAsset(assemblyDir, asset, toolkitInfo, reuse) {
    if (reuse) {
        return await prepareFileAsset(assemblyDir, asset, toolkitInfo, reuse);
    }
    const dirPath = path.isAbsolute(asset.path) ? asset.path : path.join(assemblyDir, asset.path);
    if (!(await fs.pathExists(dirPath)) || !(await fs.stat(dirPath)).isDirectory()) {
        throw new Error(`Unable to find directory: ${dirPath}`);
    }
    logging_1.debug('Preparing zip asset from directory:', dirPath);
    const staging = await fs.mkdtemp(path.join(os.tmpdir(), 'cdk-assets'));
    try {
        const archiveFile = path.join(staging, 'archive.zip');
        await archive_1.zipDirectory(dirPath, archiveFile);
        logging_1.debug('zip archive:', archiveFile);
        return await prepareFileAsset(assemblyDir, asset, toolkitInfo, reuse, archiveFile, 'application/zip');
    }
    finally {
        await fs.remove(staging);
    }
}
/**
 * @param asset The asset descriptor
 * @param toolkitInfo The toolkit stack
 * @param filePath Alternative file path to use (instead of asset.path)
 * @param contentType Content-type to use when uploading to S3 (none will be specified by default)
 */
async function prepareFileAsset(assemblyDir, asset, toolkitInfo, reuse, filePath, contentType) {
    if (reuse) {
        return [
            { ParameterKey: asset.s3BucketParameter, UsePreviousValue: true },
            { ParameterKey: asset.s3KeyParameter, UsePreviousValue: true },
            { ParameterKey: asset.artifactHashParameter, UsePreviousValue: true },
        ];
    }
    filePath = filePath || asset.path;
    if (!path.isAbsolute(filePath)) {
        filePath = path.join(assemblyDir, filePath);
    }
    logging_1.debug('Preparing file asset:', filePath);
    const data = await fs.readFile(filePath);
    const s3KeyPrefix = `assets/${asset.id}/`;
    const { filename, key, changed, hash } = await toolkitInfo.uploadIfChanged(data, {
        s3KeyPrefix,
        s3KeySuffix: path.extname(filePath),
        contentType
    });
    const relativePath = path.relative(process.cwd(), asset.path);
    const s3url = `s3://${toolkitInfo.bucketName}/${key}`;
    logging_1.debug(`S3 url for ${relativePath}: ${s3url}`);
    if (changed) {
        logging_1.success(`Updated: ${colors.bold(relativePath)} (${asset.packaging})`);
    }
    else {
        logging_1.debug(`Up-to-date: ${colors.bold(relativePath)} (${asset.packaging})`);
    }
    return [
        { ParameterKey: asset.s3BucketParameter, ParameterValue: toolkitInfo.bucketName },
        { ParameterKey: asset.s3KeyParameter, ParameterValue: `${s3KeyPrefix}${cxapi.ASSET_PREFIX_SEPARATOR}${filename}` },
        { ParameterKey: asset.artifactHashParameter, ParameterValue: hash },
    ];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXNzZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXNzZXRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkNBQTJDO0FBQzNDLHlDQUF5QztBQUV6QyxpQ0FBaUM7QUFDakMsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFFN0IsdUNBQXlDO0FBQ3pDLHFDQUFpRDtBQUNqRCx1Q0FBMkM7QUFFM0MsMkNBQTJDO0FBQ3BDLEtBQUssVUFBVSxhQUFhLENBQUMsS0FBd0MsRUFBRSxXQUF5QixFQUFFLEVBQVksRUFBRSxLQUFnQjtJQUNySSxLQUFLLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUNwQixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO0lBRTVCLElBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7UUFDdkIsT0FBTyxFQUFFLENBQUM7S0FDWDtJQUVELElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDaEIsMkNBQTJDO1FBQzNDLE1BQU0sSUFBSSxLQUFLLENBQUMsMEZBQTBGLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLFdBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDeEs7SUFFRCxJQUFJLE1BQU0sR0FBRyxJQUFJLEtBQUssRUFBNEIsQ0FBQztJQUNuRCxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRTtRQUMxQiwrRkFBK0Y7UUFDL0YsZ0ZBQWdGO1FBQ2hGLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRWhELElBQUksVUFBVSxFQUFFO1lBQ2QsZUFBSyxDQUFDLG1CQUFtQixLQUFLLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQzFFO2FBQU07WUFDTCxlQUFL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S0FDWixDQUFDLENBQUM7SUFFSCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFOUQsTUFBTSxLQUFLLEdBQUcsUUFBUSxXQUFXLENBQUMsVUFBVSxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3RELGVBQUssQ0FBQyxjQUFjLFlBQVksS0FBSyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQzlDLElBQUksT0FBTyxFQUFFO1FBQ1gsaUJBQU8sQ0FBQyxZQUFZLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssS0FBSyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7S0FDdkU7U0FBTTtRQUNMLGVBQUssQ0FBQyxlQUFlLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssS0FBSyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUM7S0FDeEU7SUFFRCxPQUFPO1FBQ0wsRUFBRSxZQUFZLEVBQUUsS0FBSyxDQUFDLGlCQUFpQixFQUFFLGNBQWMsRUFBRSxXQUFXLENBQUMsVUFBVSxFQUFFO1FBQ2pGLEVBQUUsWUFBWSxFQUFFLEtBQUssQ0FBQyxjQUFjLEVBQUUsY0FBYyxFQUFFLEdBQUcsV0FBVyxHQUFHLEtBQUssQ0FBQyxzQkFBc0IsR0FBRyxRQUFRLEVBQUUsRUFBRTtRQUNsSCxFQUFFLFlBQVksRUFBRSxLQUFLLENBQUMscUJBQXFCLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRTtLQUNwRSxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbmltcG9ydCAqIGFzIGN4YXBpIGZyb20gJ0Bhd3MtY2RrL2N4LWFwaSc7XG5pbXBvcnQgeyBDbG91ZEZvcm1hdGlvbiB9IGZyb20gJ2F3cy1zZGsnO1xuaW1wb3J0ICogYXMgY29sb3JzIGZyb20gJ2NvbG9ycyc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICdvcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgVG9vbGtpdEluZm8gfSBmcm9tICcuL2FwaS90b29sa2l0LWluZm8nO1xuaW1wb3J0IHsgemlwRGlyZWN0b3J5IH0gZnJvbSAnLi9hcmNoaXZlJztcbmltcG9ydCB7IHByZXBhcmVDb250YWluZXJBc3NldCB9IGZyb20gJy4vZG9ja2VyJztcbmltcG9ydCB7IGRlYnVnLCBzdWNjZXNzIH0gZnJvbSAnLi9sb2dnaW5nJztcblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByZXBhcmVBc3NldHMoc3RhY2s6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCwgdG9vbGtpdEluZm8/OiBUb29sa2l0SW5mbywgY2k/OiBib29sZWFuLCByZXVzZT86IHN0cmluZ1tdKTogUHJvbWlzZTxDbG91ZEZvcm1hdGlvbi5QYXJhbWV0ZXJbXT4ge1xuICByZXVzZSA9IHJldXNlIHx8IFtdO1xuICBjb25zdCBhc3NldHMgPSBzdGFjay5hc3NldHM7XG5cbiAgaWYgKGFzc2V0cy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBpZiAoIXRvb2xraXRJbmZvKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgIHRocm93IG5ldyBFcnJvcihgVGhpcyBzdGFjayB1c2VzIGFzc2V0cywgc28gdGhlIHRvb2xraXQgc3RhY2sgbXVzdCBiZSBkZXBsb3llZCB0byB0aGUgZW52aXJvbm1lbnQgKFJ1biBcIiR7Y29sb3JzLmJsdWUoXCJjZGsgYm9vdHN0cmFwIFwiICsgc3RhY2suZW52aXJvbm1lbnQhLm5hbWUpfVwiKWApO1xuICB9XG5cbiAgbGV0IHBhcmFtcyA9IG5ldyBBcnJheTxDbG91ZEZvcm1hdGlvbi5QYXJhbWV0ZXI+KCk7XG4gIGZvciAoY29uc3QgYXNzZXQgb2YgYXNzZXRzKSB7XG4gICAgLy8gRklYTUU6IFNob3VsZCBoYXZlIGV4Y2x1ZGVkIGJ5IGNvbnN0cnVjdCBwYXRoIGhlcmUgaW5zdGVhZCBvZiBieSB1bmlxdWUgSUQsIHByZWZlcmFibHkgdXNpbmdcbiAgICAvLyBtaW5pbWF0Y2ggc28gd2UgY2FuIHN1cHBvcnQgZ2xvYnMuIE1heWJlIHRha2UgdXAgZHVyaW5nIGFydGlmYWN0IHJlZmFjdG9yaW5nLlxuICAgIGNvbnN0IHJldXNlQXNzZXQgPSByZXVzZS5pbmRleE9mKGFzc2V0LmlkKSA+IC0xO1xuXG4gICAgaWYgKHJldXNlQXNzZXQpIHtcbiAgICAgIGRlYnVnKGBQcmVwYXJpbmcgYXNzZXQgJHthc3NldC5pZH06ICR7SlNPTi5zdHJpbmdpZnkoYXNzZXQpfSAocmV1c2luZylgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVidWcoYFByZXBhcmluZyBhc3NldCAke2Fzc2V0LmlkfTogJHtKU09OLnN0cmluZ2lmeShhc3NldCl9YCk7XG4gICAgfVxuXG4gICAgaWYgKCFzdGFjay5hc3NlbWJseSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkOiBzdGFjayBhc3NlbWJseSBpcyByZXF1aXJlZCBpbiBvcmRlciB0byBmaW5kIGFzc2V0cyBpbiBhc3NlbWx5IGRpcmVjdG9yeWApO1xuICAgIH1cblxuICAgIGNvbnN0IGFzc2VtYmx5RGlyID0gc3RhY2suYXNzZW1ibHkuZGlyZWN0b3J5O1xuICAgIHBhcmFtcyA9IHBhcmFtcy5jb25jYXQoYXdhaXQgcHJlcGFyZUFzc2V0KGFzc2VtYmx5RGlyLCBhc3NldCwgdG9vbGtpdEluZm8sIHJldXNlQXNzZXQsIGNpKSk7XG4gIH1cblxuICByZXR1cm4gcGFyYW1zO1xufVxuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG5hc3luYyBmdW5jdGlvbiBwcmVwYXJlQXNzZXQoYXNzZW1ibHlEaXI6IHN0cmluZywgYXNzZXQ6IGN4YXBpLkFzc2V0TWV0YWRhdGFFbnRyeSwgdG9vbGtpdEluZm86IFRvb2xraXRJbmZvLCByZXVzZTogYm9vbGVhbiwgY2k/OiBib29sZWFuKTogUHJvbWlzZTxDbG91ZEZvcm1hdGlvbi5QYXJhbWV0ZXJbXT4ge1xuICBzd2l0Y2ggKGFzc2V0LnBhY2thZ2luZykge1xuICAgIGNhc2UgJ3ppcCc6XG4gICAgICByZXR1cm4gYXdhaXQgcHJlcGFyZVppcEFzc2V0KGFzc2VtYmx5RGlyLCBhc3NldCwgdG9vbGtpdEluZm8sIHJldXNlKTtcbiAgICBjYXNlICdmaWxlJzpcbiAgICAgIHJldHVybiBhd2FpdCBwcmVwYXJlRmlsZUFzc2V0KGFzc2VtYmx5RGlyLCBhc3NldCwgdG9vbGtpdEluZm8sIHJldXNlKTtcbiAgICBjYXNlICdjb250YWluZXItaW1hZ2UnOlxuICAgICAgcmV0dXJuIGF3YWl0IHByZXBhcmVDb250YWluZXJBc3NldChhc3NlbWJseURpciwgYXNzZXQsIHRvb2xraXRJbmZvLCByZXVzZSwgY2kpO1xuICAgIGRlZmF1bHQ6XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIHBhY2thZ2luZyB0eXBlOiAkeyhhc3NldCBhcyBhbnkpLnBhY2thZ2luZ30uIFlvdSBtaWdodCBuZWVkIHRvIHVwZ3JhZGUgeW91ciBhd3MtY2RrIHRvb2xraXQgdG8gc3VwcG9ydCB0aGlzIGFzc2V0IHR5cGUuYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZVppcEFzc2V0KFxuICAgIGFzc2VtYmx5RGlyOiBzdHJpbmcsXG4gICAgYXNzZXQ6IGN4YXBpLkZpbGVBc3NldE1ldGFkYXRhRW50cnksXG4gICAgdG9vbGtpdEluZm86IFRvb2xraXRJbmZvLFxuICAgIHJldXNlOiBib29sZWFuKTogUHJvbWlzZTxDbG91ZEZvcm1hdGlvbi5QYXJhbWV0ZXJbXT4ge1xuXG4gIGlmIChyZXVzZSkge1xuICAgIHJldHVybiBhd2FpdCBwcmVwYXJlRmlsZUFzc2V0KGFzc2VtYmx5RGlyLCBhc3NldCwgdG9vbGtpdEluZm8sIHJldXNlKTtcbiAgfVxuXG4gIGNvbnN0IGRpclBhdGggPSBwYXRoLmlzQWJzb2x1dGUoYXNzZXQucGF0aCkgPyBhc3NldC5wYXRoIDogcGF0aC5qb2luKGFzc2VtYmx5RGlyLCBhc3NldC5wYXRoKTtcblxuICBpZiAoIShhd2FpdCBmcy5wYXRoRXhpc3RzKGRpclBhdGgpKSB8fCAhKGF3YWl0IGZzLnN0YXQoZGlyUGF0aCkpLmlzRGlyZWN0b3J5KCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIGRpcmVjdG9yeTogJHtkaXJQYXRofWApO1xuICB9XG5cbiAgZGVidWcoJ1ByZXBhcmluZyB6aXAgYXNzZXQgZnJvbSBkaXJlY3Rvcnk6JywgZGlyUGF0aCk7XG4gIGNvbnN0IHN0YWdpbmcgPSBhd2FpdCBmcy5ta2R0ZW1wKHBhdGguam9pbihvcy50bXBkaXIoKSwgJ2Nkay1hc3NldHMnKSk7XG4gIHRyeSB7XG4gICAgY29uc3QgYXJjaGl2ZUZpbGUgPSBwYXRoLmpvaW4oc3RhZ2luZywgJ2FyY2hpdmUuemlwJyk7XG4gICAgYXdhaXQgemlwRGlyZWN0b3J5KGRpclBhdGgsIGFyY2hpdmVGaWxlKTtcbiAgICBkZWJ1ZygnemlwIGFyY2hpdmU6JywgYXJjaGl2ZUZpbGUpO1xuICAgIHJldHVybiBhd2FpdCBwcmVwYXJlRmlsZUFzc2V0KGFzc2VtYmx5RGlyLCBhc3NldCwgdG9vbGtpdEluZm8sIHJldXNlLCBhcmNoaXZlRmlsZSwgJ2FwcGxpY2F0aW9uL3ppcCcpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJlbW92ZShzdGFnaW5nKTtcbiAgfVxufVxuXG4vKipcbiAqIEBwYXJhbSBhc3NldCBUaGUgYXNzZXQgZGVzY3JpcHRvclxuICogQHBhcmFtIHRvb2xraXRJbmZvIFRoZSB0b29sa2l0IHN0YWNrXG4gKiBAcGFyYW0gZmlsZVBhdGggQWx0ZXJuYXRpdmUgZmlsZSBwYXRoIHRvIHVzZSAoaW5zdGVhZCBvZiBhc3NldC5wYXRoKVxuICogQHBhcmFtIGNvbnRlbnRUeXBlIENvbnRlbnQtdHlwZSB0byB1c2Ugd2hlbiB1cGxvYWRpbmcgdG8gUzMgKG5vbmUgd2lsbCBiZSBzcGVjaWZpZWQgYnkgZGVmYXVsdClcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUZpbGVBc3NldChcbiAgICBhc3NlbWJseURpcjogc3RyaW5nLFxuICAgIGFzc2V0OiBjeGFwaS5GaWxlQXNzZXRNZXRhZGF0YUVudHJ5LFxuICAgIHRvb2xraXRJbmZvOiBUb29sa2l0SW5mbyxcbiAgICByZXVzZTogYm9vbGVhbixcbiAgICBmaWxlUGF0aD86IHN0cmluZyxcbiAgICBjb250ZW50VHlwZT86IHN0cmluZyk6IFByb21pc2U8Q2xvdWRGb3JtYXRpb24uUGFyYW1ldGVyW10+IHtcblxuICBpZiAocmV1c2UpIHtcbiAgICByZXR1cm4gW1xuICAgICAgeyBQYXJhbWV0ZXJLZXk6IGFzc2V0LnMzQnVja2V0UGFyYW1ldGVyLCBVc2VQcmV2aW91c1ZhbHVlOiB0cnVlIH0sXG4gICAgICB7IFBhcmFtZXRlcktleTogYXNzZXQuczNLZXlQYXJhbWV0ZXIsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgICAgIHsgUGFyYW1ldGVyS2V5OiBhc3NldC5hcnRpZmFjdEhhc2hQYXJhbWV0ZXIsIFVzZVByZXZpb3VzVmFsdWU6IHRydWUgfSxcbiAgICBdO1xuICB9XG5cbiAgZmlsZVBhdGggPSBmaWxlUGF0aCB8fCBhc3NldC5wYXRoO1xuXG4gIGlmICghcGF0aC5pc0Fic29sdXRlKGZpbGVQYXRoKSkge1xuICAgIGZpbGVQYXRoID0gcGF0aC5qb2luKGFzc2VtYmx5RGlyLCBmaWxlUGF0aCk7XG4gIH1cblxuICBkZWJ1ZygnUHJlcGFyaW5nIGZpbGUgYXNzZXQ6JywgZmlsZVBhdGgpO1xuXG4gIGNvbnN0IGRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZShmaWxlUGF0aCk7XG5cbiAgY29uc3QgczNLZXlQcmVmaXggPSBgYXNzZXRzLyR7YXNzZXQuaWR9L2A7XG5cbiAgY29uc3QgeyBmaWxlbmFtZSwga2V5LCBjaGFuZ2VkLCBoYXNoIH0gPSBhd2FpdCB0b29sa2l0SW5mby51cGxvYWRJZkNoYW5nZWQoZGF0YSwge1xuICAgIHMzS2V5UHJlZml4LFxuICAgIHMzS2V5U3VmZml4OiBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpLFxuICAgIGNvbnRlbnRUeXBlXG4gIH0pO1xuXG4gIGNvbnN0IHJlbGF0aXZlUGF0aCA9IHBhdGgucmVsYXRpdmUocHJvY2Vzcy5jd2QoKSwgYXNzZXQucGF0aCk7XG5cbiAgY29uc3QgczN1cmwgPSBgczM6Ly8ke3Rvb2xraXRJbmZvLmJ1Y2tldE5hbWV9LyR7a2V5fWA7XG4gIGRlYnVnKGBTMyB1cmwgZm9yICR7cmVsYXRpdmVQYXRofTogJHtzM3VybH1gKTtcbiAgaWYgKGNoYW5nZWQpIHtcbiAgICBzdWNjZXNzKGBVcGRhdGVkOiAke2NvbG9ycy5ib2xkKHJlbGF0aXZlUGF0aCl9ICgke2Fzc2V0LnBhY2thZ2luZ30pYCk7XG4gIH0gZWxzZSB7XG4gICAgZGVidWcoYFVwLXRvLWRhdGU6ICR7Y29sb3JzLmJvbGQocmVsYXRpdmVQYXRoKX0gKCR7YXNzZXQucGFja2FnaW5nfSlgKTtcbiAgfVxuXG4gIHJldHVybiBbXG4gICAgeyBQYXJhbWV0ZXJLZXk6IGFzc2V0LnMzQnVja2V0UGFyYW1ldGVyLCBQYXJhbWV0ZXJWYWx1ZTogdG9vbGtpdEluZm8uYnVja2V0TmFtZSB9LFxuICAgIHsgUGFyYW1ldGVyS2V5OiBhc3NldC5zM0tleVBhcmFtZXRlciwgUGFyYW1ldGVyVmFsdWU6IGAke3MzS2V5UHJlZml4fSR7Y3hhcGkuQVNTRVRfUFJFRklYX1NFUEFSQVRPUn0ke2ZpbGVuYW1lfWAgfSxcbiAgICB7IFBhcmFtZXRlcktleTogYXNzZXQuYXJ0aWZhY3RIYXNoUGFyYW1ldGVyLCBQYXJhbWV0ZXJWYWx1ZTogaGFzaCB9LFxuICBdO1xufVxuIl19