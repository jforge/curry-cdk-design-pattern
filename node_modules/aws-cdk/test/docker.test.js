"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const sinon = require("sinon");
const lib_1 = require("../lib");
const docker_1 = require("../lib/docker");
const os = require("../lib/os");
const mock_sdk_1 = require("./util/mock-sdk");
test('creates repository with given name', async () => {
    // GIVEN
    let createdName;
    const sdk = new mock_sdk_1.MockSDK();
    sdk.stubEcr({
        describeRepositories() {
            return { repositories: [] };
        },
        createRepository(req) {
            createdName = req.repositoryName;
            // Stop the test so that we don't actually docker build
            throw new Error('STOPTEST');
        },
    });
    const toolkit = new lib_1.ToolkitInfo({
        sdk,
        bucketName: 'BUCKET_NAME',
        bucketEndpoint: 'BUCKET_ENDPOINT',
        environment: { name: 'env', account: '1234', region: 'abc' }
    });
    // WHEN
    const asset = {
        id: 'assetId',
        imageNameParameter: 'MyParameter',
        packaging: 'container-image',
        path: '/foo',
        repositoryName: 'some-name',
        sourceHash: '0123456789abcdef',
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    expect(createdName).toBe('some-name');
});
test('derives repository name from asset id', async () => {
    // GIVEN
    let createdName;
    const sdk = new mock_sdk_1.MockSDK();
    sdk.stubEcr({
        describeRepositories() {
            return { repositories: [] };
        },
        createRepository(req) {
            createdName = req.repositoryName;
            // Stop the test so that we don't actually docker build
            throw new Error('STOPTEST');
        },
    });
    const toolkit = new lib_1.ToolkitInfo({
        sdk,
        bucketName: 'BUCKET_NAME',
        bucketEndpoint: 'BUCKET_ENDPOINT',
        environment: { name: 'env', account: '1234', region: 'abc' }
    });
    // WHEN
    const asset = {
        id: 'Stack:Construct/ABC123',
        imageNameParameter: 'MyParameter',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '0123456789abcdef',
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    expect(createdName).toBe('cdk/stack-construct-abc123');
});
test('configures lifecycle policy and image scanning', async () => {
    // GIVEN
    let putLifecyclePolicyParams;
    let putImageScanningConfigurationParams;
    const sdk = new mock_sdk_1.MockSDK();
    sdk.stubEcr({
        describeRepositories() {
            return { repositories: [] };
        },
        createRepository() {
            return {
                repository: {
                    repositoryUri: 'uri'
                }
            };
        },
        putLifecyclePolicy(params) {
            putLifecyclePolicyParams = params;
            return {};
        },
        putImageScanningConfiguration(params) {
            putImageScanningConfigurationParams = params;
            // Stop the test so that we don't actually docker build
            throw new Error('STOPTEST');
        }
    });
    const toolkit = new lib_1.ToolkitInfo({
        sdk,
        bucketName: 'BUCKET_NAME',
        bucketEndpoint: 'BUCKET_ENDPOINT',
        environment: { name: 'env', account: '1234', region: 'abc' }
    });
    // WHEN
    const asset = {
        id: 'assetId',
        imageNameParameter: 'MyParameter',
        packaging: 'container-image',
        path: '/foo',
        repositoryName: 'some-name',
        sourceHash: '0123456789abcdef',
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    expect(putLifecyclePolicyParams).toEqual({
        repositoryName: 'some-name',
        lifecyclePolicyText: JSON.stringify(lib_1.DEFAULT_REPO_LIFECYCLE)
    });
    expect(putImageScanningConfigurationParams).toEqual({
        repositoryName: 'some-name',
        imageScanningConfiguration: {
            scanOnPush: true
        }
    });
});
test('passes the correct target to docker build', async () => {
    // GIVEN
    const toolkit = new lib_1.ToolkitInfo({
        sdk: new mock_sdk_1.MockSDK(),
        bucketName: 'BUCKET_NAME',
        bucketEndpoint: 'BUCKET_ENDPOINT',
        environment: { name: 'env', account: '1234', region: 'abc' }
    });
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository').resolves({
        repositoryUri: 'uri',
        repositoryName: 'name'
    });
    const shellStub = sinon.stub(os, 'shell').rejects('STOPTEST');
    // WHEN
    const asset = {
        id: 'assetId',
        imageNameParameter: 'MyParameter',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        buildArgs: {
            a: 'b',
            c: 'd'
        },
        target: 'a-target',
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    const command = ['docker', 'build', '--build-arg', 'a=b', '--build-arg', 'c=d', '--tag', `uri:latest`, '/foo', '--target', 'a-target'];
    expect(shellStub.calledWith(command)).toBeTruthy();
    prepareEcrRepositoryStub.restore();
    shellStub.restore();
});
test('passes the correct args to docker build', async () => {
    // GIVEN
    const toolkit = new lib_1.ToolkitInfo({
        sdk: new mock_sdk_1.MockSDK(),
        bucketName: 'BUCKET_NAME',
        bucketEndpoint: 'BUCKET_ENDPOINT',
        environment: { name: 'env', account: '1234', region: 'abc' }
    });
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository').resolves({
        repositoryUri: 'uri',
        repositoryName: 'name'
    });
    const shellStub = sinon.stub(os, 'shell').rejects('STOPTEST');
    // WHEN
    const asset = {
        id: 'assetId',
        imageNameParameter: 'MyParameter',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        buildArgs: {
            a: 'b',
            c: 'd'
        }
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    const command = ['docker', 'build', '--build-arg', 'a=b', '--build-arg', 'c=d', '--tag', `uri:latest`, '/foo'];
    expect(shellStub.calledWith(command)).toBeTruthy();
    prepareEcrRepositoryStub.restore();
    shellStub.restore();
});
test('relative path', async () => {
    // GIVEN
    const toolkit = new lib_1.ToolkitInfo({
        sdk: new mock_sdk_1.MockSDK(),
        bucketName: 'BUCKET_NAME',
        bucketEndpoint: 'BUCKET_ENDPOINT',
        environment: { name: 'env', account: '1234', region: 'abc' }
    });
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository').resolves({
        repositoryUri: 'uri',
        repositoryName: 'name'
    });
    const shellStub = sinon.stub(os, 'shell').rejects('STOPTEST');
    // WHEN
    const asset = {
        id: 'assetId',
        imageNameParameter: 'MyParameter',
        packaging: 'container-image',
        path: 'relative-to-assembly',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        buildArgs: {
            a: 'b',
            c: 'd'
        }
    };
    try {
        await docker_1.prepareContainerAsset('/assembly/dir/root', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    const command = ['docker', 'build', '--build-arg', 'a=b', '--build-arg', 'c=d', '--tag', `uri:latest`, '/assembly/dir/root/relative-to-assembly'];
    expect(shellStub.calledWith(command)).toBeTruthy();
    prepareEcrRepositoryStub.restore();
    shellStub.restore();
});
test('passes the correct file to docker build', async () => {
    // GIVEN
    const toolkit = new lib_1.ToolkitInfo({
        sdk: new mock_sdk_1.MockSDK(),
        bucketName: 'BUCKET_NAME',
        bucketEndpoint: 'BUCKET_ENDPOINT',
        environment: { name: 'env', account: '1234', region: 'abc' }
    });
    const prepareEcrRepositoryStub = sinon.stub(toolkit, 'prepareEcrRepository').resolves({
        repositoryUri: 'uri',
        repositoryName: 'name'
    });
    const shellStub = sinon.stub(os, 'shell').rejects('STOPTEST');
    // WHEN
    const asset = {
        id: 'assetId',
        imageNameParameter: 'MyParameter',
        packaging: 'container-image',
        path: '/foo',
        sourceHash: '1234567890abcdef',
        repositoryName: 'some-name',
        file: 'some-file'
    };
    try {
        await docker_1.prepareContainerAsset('.', asset, toolkit, false);
    }
    catch (e) {
        if (!/STOPTEST/.test(e.toString())) {
            throw e;
        }
    }
    // THEN
    const command = ['docker', 'build', '--tag', `uri:latest`, '/foo', '--file', 'some-file'];
    expect(shellStub.calledWith(command)).toBeTruthy();
    prepareEcrRepositoryStub.restore();
    shellStub.restore();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkb2NrZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtCQUErQjtBQUMvQixnQ0FBNkQ7QUFDN0QsMENBQXNEO0FBQ3RELGdDQUFnQztBQUNoQyw4Q0FBMEM7QUFFMUMsSUFBSSxDQUFDLG9DQUFvQyxFQUFFLEtBQUssSUFBSSxFQUFFO0lBQ3BELFFBQVE7SUFFUixJQUFJLFdBQVcsQ0FBQztJQUVoQixNQUFNLEdBQUcsR0FBRyxJQUFJLGtCQUFPLEVBQUUsQ0FBQztJQUMxQixHQUFHLENBQUMsT0FBTyxDQUFDO1FBQ1Ysb0JBQW9CO1lBQ2xCLE9BQU8sRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFLENBQUM7UUFDOUIsQ0FBQztRQUVELGdCQUFnQixDQUFDLEdBQUc7WUFDbEIsV0FBVyxHQUFHLEdBQUcsQ0FBQyxjQUFjLENBQUM7WUFFakMsdURBQXVEO1lBQ3ZELE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUIsQ0FBQztLQUNGLENBQUMsQ0FBQztJQUVILE1BQU0sT0FBTyxHQUFHLElBQUksaUJBQVcsQ0FBQztRQUM5QixHQUFHO1FBQ0gsVUFBVSxFQUFFLGFBQWE7UUFDekIsY0FBYyxFQUFFLGlCQUFpQjtRQUNqQyxXQUFXLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTtLQUM3RCxDQUFDLENBQUM7SUFFSCxPQUFPO0lBQ1AsTUFBTSxLQUFLLEdBQTJDO1FBQ3BELEVBQUUsRUFBRSxTQUFTO1FBQ2Isa0JBQWtCLEVBQUUsYUFBYTtRQUNqQyxTQUFTLEVBQUUsaUJBQWlCO1FBQzVCLElBQUksRUFBRSxNQUFNO1FBQ1osY0FBYyxFQUFFLFdBQVc7UUFDM0IsVUFBVSxFQUFFLGtCQUFrQjtLQUMvQixDQUFDO0lBRUYsSUFBSTtRQUNGLE1BQU0sOEJBQXFC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LE9BQU8sRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFFMUYsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsQ0FBQztJQUVuRCx3QkFBd0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNuQyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDdEIsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0ICogYXMgc2lub24gZnJvbSAnc2lub24nO1xuaW1wb3J0IHsgREVGQVVMVF9SRVBPX0xJRkVDWUNMRSwgVG9vbGtpdEluZm8gfSBmcm9tICcuLi9saWInO1xuaW1wb3J0IHsgcHJlcGFyZUNvbnRhaW5lckFzc2V0IH0gZnJvbSAnLi4vbGliL2RvY2tlcic7XG5pbXBvcnQgKiBhcyBvcyBmcm9tICcuLi9saWIvb3MnO1xuaW1wb3J0IHsgTW9ja1NESyB9IGZyb20gJy4vdXRpbC9tb2NrLXNkayc7XG5cbnRlc3QoJ2NyZWF0ZXMgcmVwb3NpdG9yeSB3aXRoIGdpdmVuIG5hbWUnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG5cbiAgbGV0IGNyZWF0ZWROYW1lO1xuXG4gIGNvbnN0IHNkayA9IG5ldyBNb2NrU0RLKCk7XG4gIHNkay5zdHViRWNyKHtcbiAgICBkZXNjcmliZVJlcG9zaXRvcmllcygpIHtcbiAgICAgIHJldHVybiB7IHJlcG9zaXRvcmllczogW10gfTtcbiAgICB9LFxuXG4gICAgY3JlYXRlUmVwb3NpdG9yeShyZXEpIHtcbiAgICAgIGNyZWF0ZWROYW1lID0gcmVxLnJlcG9zaXRvcnlOYW1lO1xuXG4gICAgICAvLyBTdG9wIHRoZSB0ZXN0IHNvIHRoYXQgd2UgZG9uJ3QgYWN0dWFsbHkgZG9ja2VyIGJ1aWxkXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NUT1BURVNUJyk7XG4gICAgfSxcbiAgfSk7XG5cbiAgY29uc3QgdG9vbGtpdCA9IG5ldyBUb29sa2l0SW5mbyh7XG4gICAgc2RrLFxuICAgIGJ1Y2tldE5hbWU6ICdCVUNLRVRfTkFNRScsXG4gICAgYnVja2V0RW5kcG9pbnQ6ICdCVUNLRVRfRU5EUE9JTlQnLFxuICAgIGVudmlyb25tZW50OiB7IG5hbWU6ICdlbnYnLCBhY2NvdW50OiAnMTIzNCcsIHJlZ2lvbjogJ2FiYycgfVxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIGltYWdlTmFtZVBhcmFtZXRlcjogJ015UGFyYW1ldGVyJyxcbiAgICBwYWNrYWdpbmc6ICdjb250YWluZXItaW1hZ2UnLFxuICAgIHBhdGg6ICcvZm9vJyxcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgc291cmNlSGFzaDogJzAxMjM0NTY3ODlhYmNkZWYnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgcHJlcGFyZUNvbnRhaW5lckFzc2V0KCcuJywgYXNzZXQsIHRvb2xraXQsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghL1NUT1BURVNULy50ZXN0KGUudG9TdHJpbmcoKSkpIHsgdGhyb3cgZTsgfVxuICB9XG5cbiAgLy8gVEhFTlxuICBleHBlY3QoY3JlYXRlZE5hbWUpLnRvQmUoJ3NvbWUtbmFtZScpO1xufSk7XG5cbnRlc3QoJ2Rlcml2ZXMgcmVwb3NpdG9yeSBuYW1lIGZyb20gYXNzZXQgaWQnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG5cbiAgbGV0IGNyZWF0ZWROYW1lO1xuXG4gIGNvbnN0IHNkayA9IG5ldyBNb2NrU0RLKCk7XG4gIHNkay5zdHViRWNyKHtcbiAgICBkZXNjcmliZVJlcG9zaXRvcmllcygpIHtcbiAgICAgIHJldHVybiB7IHJlcG9zaXRvcmllczogW10gfTtcbiAgICB9LFxuXG4gICAgY3JlYXRlUmVwb3NpdG9yeShyZXEpIHtcbiAgICAgIGNyZWF0ZWROYW1lID0gcmVxLnJlcG9zaXRvcnlOYW1lO1xuXG4gICAgICAvLyBTdG9wIHRoZSB0ZXN0IHNvIHRoYXQgd2UgZG9uJ3QgYWN0dWFsbHkgZG9ja2VyIGJ1aWxkXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NUT1BURVNUJyk7XG4gICAgfSxcbiAgfSk7XG5cbiAgY29uc3QgdG9vbGtpdCA9IG5ldyBUb29sa2l0SW5mbyh7XG4gICAgc2RrLFxuICAgIGJ1Y2tldE5hbWU6ICdCVUNLRVRfTkFNRScsXG4gICAgYnVja2V0RW5kcG9pbnQ6ICdCVUNLRVRfRU5EUE9JTlQnLFxuICAgIGVudmlyb25tZW50OiB7IG5hbWU6ICdlbnYnLCBhY2NvdW50OiAnMTIzNCcsIHJlZ2lvbjogJ2FiYycgfVxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ1N0YWNrOkNvbnN0cnVjdC9BQkMxMjMnLFxuICAgIGltYWdlTmFtZVBhcmFtZXRlcjogJ015UGFyYW1ldGVyJyxcbiAgICBwYWNrYWdpbmc6ICdjb250YWluZXItaW1hZ2UnLFxuICAgIHBhdGg6ICcvZm9vJyxcbiAgICBzb3VyY2VIYXNoOiAnMDEyMzQ1Njc4OWFiY2RlZicsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBwcmVwYXJlQ29udGFpbmVyQXNzZXQoJy4nLCBhc3NldCwgdG9vbGtpdCwgZmFsc2UpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKCEvU1RPUFRFU1QvLnRlc3QoZS50b1N0cmluZygpKSkgeyB0aHJvdyBlOyB9XG4gIH1cblxuICAvLyBUSEVOXG4gIGV4cGVjdChjcmVhdGVkTmFtZSkudG9CZSgnY2RrL3N0YWNrLWNvbnN0cnVjdC1hYmMxMjMnKTtcbn0pO1xuXG50ZXN0KCdjb25maWd1cmVzIGxpZmVjeWNsZSBwb2xpY3kgYW5kIGltYWdlIHNjYW5uaW5nJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBsZXQgcHV0TGlmZWN5Y2xlUG9saWN5UGFyYW1zO1xuICBsZXQgcHV0SW1hZ2VTY2FubmluZ0NvbmZpZ3VyYXRpb25QYXJhbXM7XG5cbiAgY29uc3Qgc2RrID0gbmV3IE1vY2tTREsoKTtcbiAgc2RrLnN0dWJFY3Ioe1xuICAgIGRlc2NyaWJlUmVwb3NpdG9yaWVzKCkge1xuICAgICAgcmV0dXJuIHsgcmVwb3NpdG9yaWVzOiBbXSB9O1xuICAgIH0sXG5cbiAgICBjcmVhdGVSZXBvc2l0b3J5KCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcmVwb3NpdG9yeToge1xuICAgICAgICAgIHJlcG9zaXRvcnlVcmk6ICd1cmknXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfSxcblxuICAgIHB1dExpZmVjeWNsZVBvbGljeShwYXJhbXMpIHtcbiAgICAgIHB1dExpZmVjeWNsZVBvbGljeVBhcmFtcyA9IHBhcmFtcztcbiAgICAgIHJldHVybiB7fTtcbiAgICB9LFxuXG4gICAgcHV0SW1hZ2VTY2FubmluZ0NvbmZpZ3VyYXRpb24ocGFyYW1zKSB7XG4gICAgICBwdXRJbWFnZVNjYW5uaW5nQ29uZmlndXJhdGlvblBhcmFtcyA9IHBhcmFtcztcblxuICAgICAgLy8gU3RvcCB0aGUgdGVzdCBzbyB0aGF0IHdlIGRvbid0IGFjdHVhbGx5IGRvY2tlciBidWlsZFxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTVE9QVEVTVCcpO1xuICAgIH1cbiAgfSk7XG5cbiAgY29uc3QgdG9vbGtpdCA9IG5ldyBUb29sa2l0SW5mbyh7XG4gICAgc2RrLFxuICAgIGJ1Y2tldE5hbWU6ICdCVUNLRVRfTkFNRScsXG4gICAgYnVja2V0RW5kcG9pbnQ6ICdCVUNLRVRfRU5EUE9JTlQnLFxuICAgIGVudmlyb25tZW50OiB7IG5hbWU6ICdlbnYnLCBhY2NvdW50OiAnMTIzNCcsIHJlZ2lvbjogJ2FiYycgfVxuICB9KTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIGltYWdlTmFtZVBhcmFtZXRlcjogJ015UGFyYW1ldGVyJyxcbiAgICBwYWNrYWdpbmc6ICdjb250YWluZXItaW1hZ2UnLFxuICAgIHBhdGg6ICcvZm9vJyxcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgc291cmNlSGFzaDogJzAxMjM0NTY3ODlhYmNkZWYnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgcHJlcGFyZUNvbnRhaW5lckFzc2V0KCcuJywgYXNzZXQsIHRvb2xraXQsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghL1NUT1BURVNULy50ZXN0KGUudG9TdHJpbmcoKSkpIHsgdGhyb3cgZTsgfVxuICB9XG5cbiAgLy8gVEhFTlxuICBleHBlY3QocHV0TGlmZWN5Y2xlUG9saWN5UGFyYW1zKS50b0VxdWFsKHtcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgbGlmZWN5Y2xlUG9saWN5VGV4dDogSlNPTi5zdHJpbmdpZnkoREVGQVVMVF9SRVBPX0xJRkVDWUNMRSlcbiAgfSk7XG5cbiAgZXhwZWN0KHB1dEltYWdlU2Nhbm5pbmdDb25maWd1cmF0aW9uUGFyYW1zKS50b0VxdWFsKHtcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgaW1hZ2VTY2FubmluZ0NvbmZpZ3VyYXRpb246IHtcbiAgICAgIHNjYW5PblB1c2g6IHRydWVcbiAgICB9XG4gIH0pO1xufSk7XG5cbnRlc3QoJ3Bhc3NlcyB0aGUgY29ycmVjdCB0YXJnZXQgdG8gZG9ja2VyIGJ1aWxkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCB0b29sa2l0ID0gbmV3IFRvb2xraXRJbmZvKHtcbiAgICBzZGs6IG5ldyBNb2NrU0RLKCksXG4gICAgYnVja2V0TmFtZTogJ0JVQ0tFVF9OQU1FJyxcbiAgICBidWNrZXRFbmRwb2ludDogJ0JVQ0tFVF9FTkRQT0lOVCcsXG4gICAgZW52aXJvbm1lbnQ6IHsgbmFtZTogJ2VudicsIGFjY291bnQ6ICcxMjM0JywgcmVnaW9uOiAnYWJjJyB9XG4gIH0pO1xuXG4gIGNvbnN0IHByZXBhcmVFY3JSZXBvc2l0b3J5U3R1YiA9IHNpbm9uLnN0dWIodG9vbGtpdCwgJ3ByZXBhcmVFY3JSZXBvc2l0b3J5JykucmVzb2x2ZXMoe1xuICAgIHJlcG9zaXRvcnlVcmk6ICd1cmknLFxuICAgIHJlcG9zaXRvcnlOYW1lOiAnbmFtZSdcbiAgfSk7XG5cbiAgY29uc3Qgc2hlbGxTdHViID0gc2lub24uc3R1YihvcywgJ3NoZWxsJykucmVqZWN0cygnU1RPUFRFU1QnKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIGltYWdlTmFtZVBhcmFtZXRlcjogJ015UGFyYW1ldGVyJyxcbiAgICBwYWNrYWdpbmc6ICdjb250YWluZXItaW1hZ2UnLFxuICAgIHBhdGg6ICcvZm9vJyxcbiAgICBzb3VyY2VIYXNoOiAnMTIzNDU2Nzg5MGFiY2RlZicsXG4gICAgcmVwb3NpdG9yeU5hbWU6ICdzb21lLW5hbWUnLFxuICAgIGJ1aWxkQXJnczoge1xuICAgICAgYTogJ2InLFxuICAgICAgYzogJ2QnXG4gICAgfSxcbiAgICB0YXJnZXQ6ICdhLXRhcmdldCcsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBwcmVwYXJlQ29udGFpbmVyQXNzZXQoJy4nLCBhc3NldCwgdG9vbGtpdCwgZmFsc2UsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmICghL1NUT1BURVNULy50ZXN0KGUudG9TdHJpbmcoKSkpIHsgdGhyb3cgZTsgfVxuICB9XG5cbiAgLy8gVEhFTlxuICBjb25zdCBjb21tYW5kID0gWydkb2NrZXInLCAnYnVpbGQnLCAnLS1idWlsZC1hcmcnLCAnYT1iJywgJy0tYnVpbGQtYXJnJywgJ2M9ZCcsICctLXRhZycsIGB1cmk6bGF0ZXN0YCwgJy9mb28nLCAnLS10YXJnZXQnLCAnYS10YXJnZXQnXTtcbiAgZXhwZWN0KHNoZWxsU3R1Yi5jYWxsZWRXaXRoKGNvbW1hbmQpKS50b0JlVHJ1dGh5KCk7XG5cbiAgcHJlcGFyZUVjclJlcG9zaXRvcnlTdHViLnJlc3RvcmUoKTtcbiAgc2hlbGxTdHViLnJlc3RvcmUoKTtcbn0pO1xuXG50ZXN0KCdwYXNzZXMgdGhlIGNvcnJlY3QgYXJncyB0byBkb2NrZXIgYnVpbGQnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHRvb2xraXQgPSBuZXcgVG9vbGtpdEluZm8oe1xuICAgIHNkazogbmV3IE1vY2tTREsoKSxcbiAgICBidWNrZXROYW1lOiAnQlVDS0VUX05BTUUnLFxuICAgIGJ1Y2tldEVuZHBvaW50OiAnQlVDS0VUX0VORFBPSU5UJyxcbiAgICBlbnZpcm9ubWVudDogeyBuYW1lOiAnZW52JywgYWNjb3VudDogJzEyMzQnLCByZWdpb246ICdhYmMnIH1cbiAgfSk7XG5cbiAgY29uc3QgcHJlcGFyZUVjclJlcG9zaXRvcnlTdHViID0gc2lub24uc3R1Yih0b29sa2l0LCAncHJlcGFyZUVjclJlcG9zaXRvcnknKS5yZXNvbHZlcyh7XG4gICAgcmVwb3NpdG9yeVVyaTogJ3VyaScsXG4gICAgcmVwb3NpdG9yeU5hbWU6ICduYW1lJ1xuICB9KTtcblxuICBjb25zdCBzaGVsbFN0dWIgPSBzaW5vbi5zdHViKG9zLCAnc2hlbGwnKS5yZWplY3RzKCdTVE9QVEVTVCcpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgYXNzZXQ6IGN4YXBpLkNvbnRhaW5lckltYWdlQXNzZXRNZXRhZGF0YUVudHJ5ID0ge1xuICAgIGlkOiAnYXNzZXRJZCcsXG4gICAgaW1hZ2VOYW1lUGFyYW1ldGVyOiAnTXlQYXJhbWV0ZXInLFxuICAgIHBhY2thZ2luZzogJ2NvbnRhaW5lci1pbWFnZScsXG4gICAgcGF0aDogJy9mb28nLFxuICAgIHNvdXJjZUhhc2g6ICcxMjM0NTY3ODkwYWJjZGVmJyxcbiAgICByZXBvc2l0b3J5TmFtZTogJ3NvbWUtbmFtZScsXG4gICAgYnVpbGRBcmdzOiB7XG4gICAgICBhOiAnYicsXG4gICAgICBjOiAnZCdcbiAgICB9XG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBwcmVwYXJlQ29udGFpbmVyQXNzZXQoJy4nLCBhc3NldCwgdG9vbGtpdCwgZmFsc2UpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKCEvU1RPUFRFU1QvLnRlc3QoZS50b1N0cmluZygpKSkgeyB0aHJvdyBlOyB9XG4gIH1cblxuICAvLyBUSEVOXG4gIGNvbnN0IGNvbW1hbmQgPSBbJ2RvY2tlcicsICdidWlsZCcsICctLWJ1aWxkLWFyZycsICdhPWInLCAnLS1idWlsZC1hcmcnLCAnYz1kJywgJy0tdGFnJywgYHVyaTpsYXRlc3RgLCAnL2ZvbyddO1xuICBleHBlY3Qoc2hlbGxTdHViLmNhbGxlZFdpdGgoY29tbWFuZCkpLnRvQmVUcnV0aHkoKTtcblxuICBwcmVwYXJlRWNyUmVwb3NpdG9yeVN0dWIucmVzdG9yZSgpO1xuICBzaGVsbFN0dWIucmVzdG9yZSgpO1xufSk7XG5cbnRlc3QoJ3JlbGF0aXZlIHBhdGgnLCBhc3luYyAoKSA9PiB7XG4gIC8vIEdJVkVOXG4gIGNvbnN0IHRvb2xraXQgPSBuZXcgVG9vbGtpdEluZm8oe1xuICAgIHNkazogbmV3IE1vY2tTREsoKSxcbiAgICBidWNrZXROYW1lOiAnQlVDS0VUX05BTUUnLFxuICAgIGJ1Y2tldEVuZHBvaW50OiAnQlVDS0VUX0VORFBPSU5UJyxcbiAgICBlbnZpcm9ubWVudDogeyBuYW1lOiAnZW52JywgYWNjb3VudDogJzEyMzQnLCByZWdpb246ICdhYmMnIH1cbiAgfSk7XG5cbiAgY29uc3QgcHJlcGFyZUVjclJlcG9zaXRvcnlTdHViID0gc2lub24uc3R1Yih0b29sa2l0LCAncHJlcGFyZUVjclJlcG9zaXRvcnknKS5yZXNvbHZlcyh7XG4gICAgcmVwb3NpdG9yeVVyaTogJ3VyaScsXG4gICAgcmVwb3NpdG9yeU5hbWU6ICduYW1lJ1xuICB9KTtcblxuICBjb25zdCBzaGVsbFN0dWIgPSBzaW5vbi5zdHViKG9zLCAnc2hlbGwnKS5yZWplY3RzKCdTVE9QVEVTVCcpO1xuXG4gIC8vIFdIRU5cbiAgY29uc3QgYXNzZXQ6IGN4YXBpLkNvbnRhaW5lckltYWdlQXNzZXRNZXRhZGF0YUVudHJ5ID0ge1xuICAgIGlkOiAnYXNzZXRJZCcsXG4gICAgaW1hZ2VOYW1lUGFyYW1ldGVyOiAnTXlQYXJhbWV0ZXInLFxuICAgIHBhY2thZ2luZzogJ2NvbnRhaW5lci1pbWFnZScsXG4gICAgcGF0aDogJ3JlbGF0aXZlLXRvLWFzc2VtYmx5JyxcbiAgICBzb3VyY2VIYXNoOiAnMTIzNDU2Nzg5MGFiY2RlZicsXG4gICAgcmVwb3NpdG9yeU5hbWU6ICdzb21lLW5hbWUnLFxuICAgIGJ1aWxkQXJnczoge1xuICAgICAgYTogJ2InLFxuICAgICAgYzogJ2QnXG4gICAgfVxuICB9O1xuXG4gIHRyeSB7XG4gICAgYXdhaXQgcHJlcGFyZUNvbnRhaW5lckFzc2V0KCcvYXNzZW1ibHkvZGlyL3Jvb3QnLCBhc3NldCwgdG9vbGtpdCwgZmFsc2UpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKCEvU1RPUFRFU1QvLnRlc3QoZS50b1N0cmluZygpKSkgeyB0aHJvdyBlOyB9XG4gIH1cblxuICAvLyBUSEVOXG4gIGNvbnN0IGNvbW1hbmQgPSBbJ2RvY2tlcicsICdidWlsZCcsICctLWJ1aWxkLWFyZycsICdhPWInLCAnLS1idWlsZC1hcmcnLCAnYz1kJywgJy0tdGFnJywgYHVyaTpsYXRlc3RgLCAnL2Fzc2VtYmx5L2Rpci9yb290L3JlbGF0aXZlLXRvLWFzc2VtYmx5J107XG4gIGV4cGVjdChzaGVsbFN0dWIuY2FsbGVkV2l0aChjb21tYW5kKSkudG9CZVRydXRoeSgpO1xuXG4gIHByZXBhcmVFY3JSZXBvc2l0b3J5U3R1Yi5yZXN0b3JlKCk7XG4gIHNoZWxsU3R1Yi5yZXN0b3JlKCk7XG59KTtcblxudGVzdCgncGFzc2VzIHRoZSBjb3JyZWN0IGZpbGUgdG8gZG9ja2VyIGJ1aWxkJywgYXN5bmMgKCkgPT4ge1xuICAvLyBHSVZFTlxuICBjb25zdCB0b29sa2l0ID0gbmV3IFRvb2xraXRJbmZvKHtcbiAgICBzZGs6IG5ldyBNb2NrU0RLKCksXG4gICAgYnVja2V0TmFtZTogJ0JVQ0tFVF9OQU1FJyxcbiAgICBidWNrZXRFbmRwb2ludDogJ0JVQ0tFVF9FTkRQT0lOVCcsXG4gICAgZW52aXJvbm1lbnQ6IHsgbmFtZTogJ2VudicsIGFjY291bnQ6ICcxMjM0JywgcmVnaW9uOiAnYWJjJyB9XG4gIH0pO1xuXG4gIGNvbnN0IHByZXBhcmVFY3JSZXBvc2l0b3J5U3R1YiA9IHNpbm9uLnN0dWIodG9vbGtpdCwgJ3ByZXBhcmVFY3JSZXBvc2l0b3J5JykucmVzb2x2ZXMoe1xuICAgIHJlcG9zaXRvcnlVcmk6ICd1cmknLFxuICAgIHJlcG9zaXRvcnlOYW1lOiAnbmFtZSdcbiAgfSk7XG5cbiAgY29uc3Qgc2hlbGxTdHViID0gc2lub24uc3R1YihvcywgJ3NoZWxsJykucmVqZWN0cygnU1RPUFRFU1QnKTtcblxuICAvLyBXSEVOXG4gIGNvbnN0IGFzc2V0OiBjeGFwaS5Db250YWluZXJJbWFnZUFzc2V0TWV0YWRhdGFFbnRyeSA9IHtcbiAgICBpZDogJ2Fzc2V0SWQnLFxuICAgIGltYWdlTmFtZVBhcmFtZXRlcjogJ015UGFyYW1ldGVyJyxcbiAgICBwYWNrYWdpbmc6ICdjb250YWluZXItaW1hZ2UnLFxuICAgIHBhdGg6ICcvZm9vJyxcbiAgICBzb3VyY2VIYXNoOiAnMTIzNDU2Nzg5MGFiY2RlZicsXG4gICAgcmVwb3NpdG9yeU5hbWU6ICdzb21lLW5hbWUnLFxuICAgIGZpbGU6ICdzb21lLWZpbGUnXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBwcmVwYXJlQ29udGFpbmVyQXNzZXQoJy4nLCBhc3NldCwgdG9vbGtpdCwgZmFsc2UpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgaWYgKCEvU1RPUFRFU1QvLnRlc3QoZS50b1N0cmluZygpKSkgeyB0aHJvdyBlOyB9XG4gIH1cblxuICAvLyBUSEVOXG4gIGNvbnN0IGNvbW1hbmQgPSBbJ2RvY2tlcicsICdidWlsZCcsICctLXRhZycsIGB1cmk6bGF0ZXN0YCwgJy9mb28nLCAnLS1maWxlJywgJ3NvbWUtZmlsZSddO1xuXG4gIGV4cGVjdChzaGVsbFN0dWIuY2FsbGVkV2l0aChjb21tYW5kKSkudG9CZVRydXRoeSgpO1xuXG4gIHByZXBhcmVFY3JSZXBvc2l0b3J5U3R1Yi5yZXN0b3JlKCk7XG4gIHNoZWxsU3R1Yi5yZXN0b3JlKCk7XG59KTtcbiJdfQ==